# 聚合支付平台需求規格書

## 前言

本文件旨在詳細闡述聚合支付平台的需求規格，作為專案開發、測試、驗收的基礎。它將明確定義系統的功能性與非功能性需求，確保所有相關方對專案目標和範圍達成共識。本規格書將指導開發團隊構建一個滿足業務需求、高效、安全且具備高度擴展性的支付解決方案。

## 1. 專案概述與目標

### 1.1 專案概述

聚合支付平台是一個綜合性的支付解決方案，旨在整合多種支付通道（包括法幣和加密貨幣），提供統一的支付介面和管理功能。平台支援多層級代理體系、靈活的商戶結算機制，並內建強大的風控模組，以確保交易安全與合規性。透過微服務架構和 Supabase 作為核心資料庫，平台具備高可用性、可擴展性和易於維護的特性。

### 1.2 專案目標

*   提供一個穩定、高效、安全的聚合支付服務。
*   支援多幣種、多支付通道的靈活配置與管理。
*   建立完善的多層級代理分潤體系。
*   實現自動化與可配置的商戶結算流程。
*   透過先進的風控機制保障交易安全。
*   提供友善且功能完善的商戶、代理和管理後台介面。
*   支援多語言，滿足國際化業務需求。

## 2. 使用者角色

平台主要包含以下三種使用者角色，每種角色擁有不同的權限和功能。

### 2.1 管理員 (Admin)

*   **職責**：負責平台的整體營運、系統配置、使用者管理、風險監控和財務審核。
*   **主要功能**：
    *   系統參數配置與管理（如費率、匯率、結算週期）。
    *   使用者（商戶、代理、其他管理員）的註冊審核、帳戶管理、權限分配。
    *   支付通道的開通、配置、監控與維護。
    *   交易查詢、訂單管理、退款審核。
    *   結算單審核與資金撥付。
    *   風控規則配置與風險事件處理。
    *   日誌查詢與系統監控。
    *   多語言內容管理。

### 2.2 代理 (Agent)

*   **職責**：負責拓展商戶、管理下級代理和商戶，並從其下級交易中獲取分潤。
*   **主要功能**：
    *   代理帳戶資訊管理。
    *   下級代理和商戶的開通、管理與審核。
    *   查看其下級商戶的交易數據與結算報告。
    *   查詢自身的分潤明細與結算單。
    *   配置其下級商戶的結算週期和費率（在平台允許範圍內）。
    *   提現申請與查詢。

### 2.3 商戶 (Merchant)

*   **職責**：使用平台提供的支付服務，管理其支付訂單和財務數據。
*   **主要功能**：
    *   商戶帳戶資訊管理。
    *   支付訂單的發起、查詢與管理。
    *   查看交易記錄、對帳單與結算報告。
    *   配置支付通道、回調地址和安全憑證。
    *   提現申請與查詢。
    *   API 金鑰管理。

## 3. 功能需求 (Functional Requirements)

### 3.1 支付功能

*   **多幣種支援**：支援主流法幣（如 USD, EUR, TWD）和加密貨幣（如 BTC, ETH, USDT）的支付處理。
*   **多支付通道整合**：能夠無縫介接多個第三方支付通道，包括銀行、信用卡、電子錢包、加密貨幣交易所等。
*   **智能支付路由**：根據商戶配置、交易金額、幣種、風控結果、通道狀態等因素，自動選擇最佳支付通道。
*   **交易處理**：支援支付請求的發起、狀態查詢、退款、撤銷等操作。
*   **支付狀態管理**：實時追蹤並更新支付交易狀態，提供回調通知機制。
*   **API 收銀台**：提供標準化 API 介面，供商戶後端直接發起支付請求。
*   **QR 碼收銀台**：支援生成動態或靜態 QR 碼，供使用者掃碼完成支付。

### 3.2 通道管理

*   **通道配置**：管理支付通道的參數、憑證、費率、支援幣種、限額等。
*   **通道監控**：實時監控通道運行狀態、交易成功率、響應時間。
*   **通道切換**：支援自動或手動切換備用通道。
*   **費率管理**：配置不同通道、幣種、交易類型的費率策略。

### 3.3 代理管理

*   **代理註冊與審核**：提供代理商註冊流程及平台審核機制。
*   **多層級代理結構**：支援無限層級的代理關係。
*   **分潤模式**：支援百分比分潤、固定金額分潤、以及 **mark-up 機制**（即在基礎費率上加價作為代理分潤）。
*   **分潤計算**：根據代理層級、分潤策略和交易數據，自動計算各級代理的分潤金額。
*   **代理權限管理**：配置代理商對其下級代理和商戶的管理權限。

### 3.4 商戶管理

*   **商戶註冊與審核**：提供商戶入駐流程及 KYC/AML 審核。
*   **商戶配置**：管理商戶的支付參數、回調地址、安全憑證、支援幣種與支付通道。
*   **訂單與交易查詢**：提供商戶查詢其所有支付訂單和交易詳情的介面。
*   **商戶結算配置**：設定商戶的結算週期、結算帳戶與提現規則。

### 3.5 結算系統

*   **交易清算**：對所有完成的交易進行資金清算，確認應收應付金額。
*   **對帳管理**：與支付通道、銀行進行對帳，處理差異。
*   **商戶結算**：根據預設週期（日、週、月）或手動觸發，將商戶的淨收入結算至其指定帳戶。支援的結算週期範圍為 **D+0 到 T+30**，具體週期可由上層（代理或管理員）指定。
*   **代理分潤結算**：根據分潤計算結果，將代理商的分潤金額結算至其指定帳戶。
*   **報表生成**：生成各類結算報表、對帳單與財務報表。

### 3.6 風控模組

*   **規則引擎**：基於預設或動態配置的風控規則進行實時風險評估。
*   **黑白名單管理**：管理高風險使用者、IP、設備或帳戶的黑名單，以及可信任實體的白名單。
*   **異常行為檢測**：檢測異常交易模式，如盜刷、欺詐。
*   **風險評分**：對每筆交易進行風險評分，並根據分數觸發不同處理策略。
*   **預警與報警**：實時發送預警通知給營運人員。

## 4. 非功能需求 (Non-functional Requirements)

### 4.1 效能 (Performance)

*   **響應時間**：核心支付交易 API 響應時間應在 200ms 以內。
*   **吞吐量**：系統應能支援每秒至少 1000 筆交易的處理能力。
*   **可擴展性**：系統應採用微服務架構，支援水平擴展，以應對業務量的增長。

### 4.2 安全性 (Security)

*   **數據加密**：所有敏感數據（如支付憑證、使用者密碼）應進行加密儲存和傳輸。
*   **身份驗證與授權**：利用 Supabase Auth 和 JWT 實現強大且安全的身份驗證與授權機制。
*   **Row Level Security (RLS)**：透過 Supabase 的 RLS 功能，在資料庫層面實現精細的資料存取控制。
*   **API 安全**：API 應採用 HTTPS，並實施簽名驗證、防重放攻擊等安全措施。
*   **風控**：透過風控模組有效識別和防範欺詐、洗錢等風險。
*   **日誌審計**：所有關鍵操作和交易應記錄詳細日誌，便於審計和追溯。

### 4.3 可用性 (Availability)

*   **高可用性**：系統應具備高可用性設計，關鍵服務應支援故障轉移和自動恢復，確保 99.9% 的服務可用時間。
*   **容錯性**：單點故障不應導致整個系統癱瘓。
*   **備份與恢復**：資料庫應定期備份，並具備快速恢復機制。

### 4.4 可維護性 (Maintainability)

*   **模組化設計**：系統應採用微服務架構，各服務模組獨立開發、部署和維護。
*   **文件完善**：提供清晰的系統架構、資料庫設計、API 文件和部署指南。
*   **程式碼規範**：遵循統一的程式碼規範和開發標準。

### 4.5 多語言支援 (Multi-language Support)

*   **支援語言**：系統介面和部分業務內容應支援**繁體中文、簡體中文、英文、日文、韓文、泰文、越南文**。
*   **語言切換**：使用者應能方便地切換介面語言。
*   **內容本地化**：對於需要多語言顯示的資料，應透過資料庫翻譯機制進行管理。

## 5. 部署與運維需求

*   **容器化**：所有微服務應支援 Docker 容器化部署。
*   **自動化部署**：支援 CI/CD 流程，實現自動化建構、測試和部署。
*   **監控與日誌**：提供全面的系統監控（如 Prometheus, Grafana）和日誌管理（如 ELK Stack）解決方案。
*   **環境隔離**：支援開發、測試、生產環境的隔離部署。

## 6. 附錄

*   **術語表**：定義本文件中使用的專業術語。
*   **參考文獻**：列出相關的參考資料和標準。
