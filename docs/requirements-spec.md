# 需求規格說明書

## 概述

本文件詳細說明了聚合支付平台的功能需求、非功能需求以及技術棧。本次更新主要涉及將資料庫從 Supabase 遷移至自建 PostgreSQL，並相應調整認證機制和相關程式碼。

## 功能需求

### 1. 用戶管理
- 用戶註冊、登入、登出功能。
- 角色管理（例如：商戶、代理商、管理員）。

### 2. 支付交易
- 支援多種支付方式（例如：信用卡、電子錢包、銀行轉帳）。
- 交易發起、查詢、退款、撤銷功能。
- 交易狀態實時更新。

### 3. 商戶管理
- 商戶資訊註冊、審核、修改。
- 商戶帳戶餘額查詢、提現申請。

### 4. 代理商管理
- 代理商資訊註冊、審核、修改。
- 代理商佣金計算與結算。

### 5. 結算管理
- 定期自動結算功能。
- 結算報表生成與查詢。

### 6. 風險控制
- 實時交易監控與風險預警。
- 風控規則配置與管理。

### 7. 支付通道管理
- 支付通道配置、啟用、禁用。
- 支付通道路由策略。

## 非功能需求

### 1. 性能
- 交易處理響應時間 < 500ms。
- 系統支援每秒處理至少 1000 筆交易。

### 2. 可用性
- 系統年可用性 > 99.9%。
- 支援熱備份和故障轉移。

### 3. 安全性
- 所有敏感資料加密儲存。
- 採用 JWT 進行認證與授權。
- 防止 SQL 注入、XSS 等常見網路攻擊。

### 4. 可擴展性
- 微服務架構，支援獨立部署和水平擴展。
- 資料庫支援讀寫分離和分庫分表。

### 5. 可維護性
- 程式碼遵循一致的編碼規範，具備清晰的註解和文件。
- 提供完善的日誌和監控系統。

## 技術棧更新

### 後端
- **語言**: Node.js
- **框架**: Express.js
- **資料庫**: PostgreSQL (自建)
- **資料庫 ORM/Query Builder**: `knex.js`
- **資料庫驅動**: `pg` (node-postgres)
- **認證**: JWT (`jsonwebtoken`, `bcrypt`)
- **快取**: Redis
- **訊息佇列**: RabbitMQ

### 前端
- **框架**: React.js
- **狀態管理**: (根據專案實際情況填寫，例如 Redux, Zustand, React Context)
- **認證**: 自建 JWT 認證模組
- **API 請求**: `axios` 或 `fetch`

### 開發工具
- **版本控制**: Git
- **套件管理**: npm / yarn

## 參考資料

[1] [Node.js 官方網站](https://nodejs.org/)
[2] [Express.js 官方網站](https://expressjs.com/)
[3] [PostgreSQL 官方網站](https://www.postgresql.org/)
[4] [Knex.js 官方網站](https://knexjs.org/)
[5] [jsonwebtoken npm 套件](https://www.npmjs.com/package/jsonwebtoken)
[6] [bcrypt npm 套件](https://www.npmjs.com/package/bcrypt)
